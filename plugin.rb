# name: Steam authentication with Discourse
# about: Authenticate with Discourse with Steam
# version: 0.3.0
# author: J. de Faye, Sam Saffron

require File.expand_path('../omniauth-steam.rb', __FILE__)

class SteamAuthenticator < ::Auth::Authenticator

  def name
    'steam'
  end

  def after_authenticate(auth_token)
    result = Auth::Result.new

    data = auth_token[:info]
    raw_info = auth_token["extra"]["raw_info"]
    name = data["nickname"]
    steam_uid = auth_token["uid"]

    current_info = ::PluginStore.get('steam', "steam_uid_#{steam_uid}")

    result.user =
      if current_info
        User.where(id: current_info[:user_id]).first
      end

    result.name = name
    result.extra_data = { steam_uid: steam_uid }

    result
  end

  def after_create_account(user, auth)
    data = auth[:extra_data]
    ::PluginStore.set('steam', "steam_uid_#{data[:steam_uid]}",
      {user_id: user.id })
  end

  def register_middleware(omniauth)
    omniauth.provider :steam, ENV['STEAM_WEB_API_KEY']
  end

end

auth_provider title: ' ',
    message: 'Sign in via Steam (Make sure pop up blockers are not enabled).',
    frame_width: 960,
    frame_height: 800,
    authenticator: SteamAuthenticator.new

register_css <<CSS

#login-buttons button {
  margin: 5px;
  min-width: 114px;
}

.btn-social.steam {
  color: #000;
  background: transparent url("data:image/png;base64,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");
  background-size: contain;
  float: right;
  height: 43px;
  width: 114px;
}

.btn-social.steam:before {
  content: "";
}

CSS
